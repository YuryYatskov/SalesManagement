@page "/employee-managment"
@using SMApp.Data.Entities
@using SMApp.Models
@using SMApp.Models.Reports
@using SMApp.Services.Contracts
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Spinner
@rendermode InteractiveServer
@inject IEmployeeManagementService EmployeeManagementService

<h3>Employee management</h3>

<div style="max-width:1100px">
    <SfGrid @ref="EmployeeGrid" DataSource="@employeeData" AllowSorting="true" AllowExcelExport="true" AllowPdfExport="true" Toolbar="@toolbar">
        @*  AllowFiltering="true" AllowPaging="true" AllowGrouping="true" > *@
        <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true"></GridEditSettings>
        <GridEvents
            OnActionBegin="ActionBeginHandler" 
            OnActionComplete="ActionCompleteHandler"
            OnToolbarClick="ToolbarBtnClickHandler"
            CommandClicked="OnCommandClicked"
            TValue="EmployeeModel"></GridEvents>
        <GridSortSettings>
            <GridSortColumns>
                <GridSortColumn Field="Id" Direction="SortDirection.Descending"></GridSortColumn>
            </GridSortColumns>
        </GridSortSettings>
        @*
        <GridPageSettings PageSize="5"></GridPageSettings>
        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Menu"></GridFilterSettings> *@
        <GridColumns>
            <GridColumn Field="@nameof(EmployeeModel.Id)" AllowAdding="false" IsPrimaryKey="true" Width="50px" ></GridColumn>
            <GridColumn HeaderText="Profile" Width="120px">
                <Template>
                    @{
                        var employee = (context as EmployeeModel);
                        <div class="profile-image-container">
                            <img src="@(employee?.ImagePath)" />
                        </div>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(EmployeeModel.FirstName)" HeaderText="First name" Width="120px"></GridColumn>
            <GridColumn Field="@nameof(EmployeeModel.LastName)" HeaderText="Last name" Width="120px"></GridColumn>
@*             <GridColumn Field="@nameof(EmployeeModel.EmployeeJobTitleId)" HeaderText="Designation"></GridColumn> *@
            <GridForeignColumn HeaderText="Designation" TValue="EmployeeJobTitle"
                               Field="@nameof(EmployeeModel.EmployeeJobTitleId)"
                               ForeignDataSource="employeeJobTitleData"
                               ForeignKeyValue="Name" Width="100px">
                <EditTemplate>
                    <SfDropDownList @bind-value="@((context as EmployeeModel).EmployeeJobTitleId)"
                                    ID="EmployeeJobTitleId"
                                    DataSource="employeeJobTitleData" TItem="EmployeeJobTitle"
                                    TValue="int">
                        <DropDownListFieldSettings Text="Name" Value="EmployeeJobTitleId">
                        </DropDownListFieldSettings>
                    </SfDropDownList>
                </EditTemplate>
            </GridForeignColumn>
            <GridColumn Field="@nameof(EmployeeModel.Gender)">
                <EditTemplate>
                    <SfDropDownList DataSource="genderCollection" TItem="string" TValue="string"
                        @bind-value="@((context as EmployeeModel).Gender)"></SfDropDownList>
                </EditTemplate>
            </GridColumn>
            <GridColumn Field="@nameof(EmployeeModel.Email)" Width="170px"></GridColumn>
            <GridColumn Field="@nameof(EmployeeModel.DateOfBirth)" Format="d" HeaderText="DOB"></GridColumn>
@*             <GridColumn Field="@nameof(EmployeeModel.ReportToEmpId)" HeaderText="Reports" Width="100px"></GridColumn> *@
            <GridForeignColumn HeaderText="Reports To" TValue="ReportToModel"
                               Field="@nameof(EmployeeModel.ReportToEmpId)"
                               ForeignDataSource="reportToEmployeeData"
                               ForeignKeyValue="ReportToName" Width="130px">
                <EditTemplate>
                    <SfDropDownList @bind-value="@((context as EmployeeModel).ReportToEmpId)"
                                    ID="ReportToEmpId"
                                    DataSource="reportToEmployeeData" TItem="ReportToModel"
                                    TValue="Nullable<int>">
                        <DropDownListFieldSettings Text="ReportToName" Value="ReportToEmpId">
                        </DropDownListFieldSettings>

                    </SfDropDownList>
                </EditTemplate>
            </GridForeignColumn>
            <GridColumn HeaderText="Operations" Width="110px">
                <GridCommandColumns>
                    <GridCommandColumn Type = "CommandButtonType.Edit"
                            ButtonOption="@(new CommandButtonOptions(){
                                                IconCss = "e-icons e-edit",
                                                CssClass ="e-flat"
                                            })">

                    </GridCommandColumn>
                    <GridCommandColumn Type = "CommandButtonType.Delete"
                            ButtonOption="@(new CommandButtonOptions(){
                                                IconCss = "e-icons e-delete",
                                                CssClass ="e-flat"
                                            })">

                    </GridCommandColumn>
                    <GridCommandColumn Type = "CommandButtonType.Save"
                            ButtonOption="@(new CommandButtonOptions(){
                                                IconCss = "e-icons e-update",
                                                CssClass ="e-flat"
                                            })">

                    </GridCommandColumn>
                    <GridCommandColumn Type = "CommandButtonType.Cancel"
                            ButtonOption="@(new CommandButtonOptions(){
                                                IconCss = "e-icons e-cancel-icon",
                                                CssClass ="e-flat"
                                            })">

                    </GridCommandColumn>
                </GridCommandColumns>
            </GridColumn>
            <GridColumn HeaderText = "Custom Operations" Width ="110">
                <GridCommandColumns>
                    <GridCommandColumn 
                            ButtonOption="@(new CommandButtonOptions(){
                                                Content = "O1",
                                                CssClass = "e-outline"
                                            })">

                    </GridCommandColumn>
                    <GridCommandColumn 
                            ButtonOption="@(new CommandButtonOptions(){
                                                Content = "O2",
                                                CssClass = "e-outline"
                                            })">

                    </GridCommandColumn>
                </GridCommandColumns>
            </GridColumn>
        </GridColumns>
        <SfSpinner @bind-Visible="@VisibleProp"></SfSpinner>
    </SfGrid>
</div>

<style>
    .profile-image-container {
        width: 80px;
        height: 80px;
    }

    .profile-image-container img {
        width: 100%;
        height: 100%;
        border-radius: 50px;
    }
</style>

@code {
    private SfGrid<EmployeeModel>? EmployeeGrid { get; set; }
    private List<EmployeeModel>? employeeData;
    private List<EmployeeJobTitle>? employeeJobTitleData;
    private string[] genderCollection = Enum.GetNames(typeof(GenderVal));
    private List<object> toolbar = new List<object> { "Add", "Search", "ExcelExport", "PdfExport", // "Edit", "Delete", "Update", "Cancel",
        new ItemModel() { Text = "XML Export", TooltipText = "Export Data to XML", PrefixIcon = "e-click", Id = "XmlExport" } };

    private List<ReportToModel>? reportToEmployeeData;
    private bool VisibleProp {get; set; }

    protected override async Task OnInitializedAsync()
    {
        VisibleProp = true;
        employeeData = await EmployeeManagementService.GetEmployees();
        employeeJobTitleData = await EmployeeManagementService.GetJobTitles();
        reportToEmployeeData = await EmployeeManagementService.GetReportToEmployees();

        // await Task.Delay(2000);

        VisibleProp = false;
    }

    public async void ActionBeginHandler(ActionEventArgs<EmployeeModel> args)
    {
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save))
        {
            if (args.Action == "Add")
            {
                await EmployeeManagementService.AddEmployee(args.Data);
            }
            else if (args.Action == "Edit")
            {
                await EmployeeManagementService.UpdateEmployee(args.Data);
            }
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete))
        {
            await EmployeeManagementService.DeleteEmployee(args.Data.Id);
        }
    }

    public async void ActionCompleteHandler(ActionEventArgs<EmployeeModel> args)
    {
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save))
        {
            if (args.Action == "Add")
            {
                employeeData = await EmployeeManagementService.GetEmployees();
                EmployeeGrid?.Refresh();
            }
        }
    }

    private async Task ToolbarBtnClickHandler(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id.Contains("_excelexport"))
        {
            await EmployeeGrid?.ExportToExcelAsync()!;
        }
        else if (args.Item.Id.Contains("_pdfexport"))
        {
            await EmployeeGrid?.ExportToPdfAsync()!;
        }
        else if (args.Item.Id == "XmlExport")
        {
            Console.Write("Export to Xml functionality");
        }
    }

    private void OnCommandClicked(CommandClickEventArgs<EmployeeModel> args)
    {
            if (args.CommandColumn.ButtonOption.Content == "O1")
        {
            Console.Write("Custom Operation 1");
        }
        else if (args.CommandColumn.ButtonOption.Content == "O2")
        {
            Console.Write("Custom Operation 2");
        }
    }

    private enum GenderVal
    {        
        Male,
        Female,
        Other
    }
}
